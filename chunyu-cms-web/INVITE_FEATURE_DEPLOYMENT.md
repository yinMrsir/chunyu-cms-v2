# 邀请用户注册得金币功能部署说明

## 功能概述

该功能为用户邀请好友注册提供金币奖励机制，包含以下核心功能：
- 用户生成专属邀请码
- 新用户注册时可使用邀请码
- 邀请成功后双方获得金币奖励
- 邀请记录查询和统计
- 自动化奖励发放任务

## 部署步骤

### 1. 数据库表创建

数据库表结构已经自动创建，包含以下表：
- `member_invite_code`: 邀请码表
- `member_invite_record`: 邀请记录表

### 2. 系统配置

执行以下SQL脚本来添加邀请奖励配置和定时任务：

```sql
-- 执行 invite-reward-job.sql 文件
-- 该文件包含：
-- 1. 邀请奖励发放定时任务
-- 2. 系统配置参数
```

### 3. 邀请奖励配置

系统支持以下配置参数（已自动添加到sys_config表）：

| 配置键 | 默认值 | 说明 |
|--------|--------|------|
| `inviteReward` | 50 | 邀请者奖励金币数量 |
| `inviteeReward` | 20 | 被邀请者奖励金币数量 |
| `regGold` | 10 | 注册奖励金币数量（已存在） |

可以在系统管理 -> 系统配置中修改这些参数。

### 4. 定时任务

系统已创建定时任务 `邀请奖励发放任务`，配置信息：
- **任务名称**: 邀请奖励发放任务
- **执行时间**: 每天凌晨2点 (0 0 2 * * ?)
- **执行方法**: processInviteRewards()
- **任务说明**: 自动发放邀请奖励，给注册超过24小时的用户发放邀请奖励金币

**任务逻辑**:
- 查询注册时间超过24小时且待发放奖励的邀请记录
- 给邀请者发放奖励金币
- 记录金币变动日志
- 更新邀请记录状态

## 功能使用说明

### 用户端功能

#### 1. 邀请功能位置
用户中心 -> 金币管理 -> 邀请好友标签页

#### 2. 邀请流程
1. 用户在金币页面的"邀请好友"标签页获取自己的邀请码
2. 复制邀请码分享给好友
3. 好友注册时在登录页面输入邀请码
4. 系统自动发放双方奖励

#### 3. 邀请统计信息
- 总邀请人数
- 已获奖励人数
- 获得奖励金币总数
- 邀请记录详情

### 管理员功能

#### 1. 邀请记录管理
- 系统监控 -> 任务调度 -> 邀请相关记录查询
- 可查看所有用户的邀请记录和奖励发放情况

#### 2. 系统配置
- 系统管理 -> 系统配置
- 可修改邀请奖励金额

## 技术实现细节

### 后端API接口

| 接口路径 | 方法 | 说明 |
|----------|------|------|
| `/api/web/member/invite/code` | GET | 获取用户邀请码 |
| `/api/web/member/invite/validate` | POST | 验证邀请码有效性 |
| `/api/web/member/invite/records` | GET | 获取邀请记录 |
| `/api/web/member/invite/stats` | GET | 获取邀请统计 |

### 前端页面修改

1. **登录组件** (`app/components/Login.vue`)
   - 添加邀请码输入框（可选）
   - 处理邀请奖励成功提示

2. **钱包页面** (`app/pages/user/wallet.vue`)
   - 新增"邀请好友"标签页
   - 显示邀请统计信息
   - 邀请码复制功能
   - 邀请记录列表

### 数据库表结构

#### member_invite_code (邀请码表)
```sql
member_invite_code_id: 主键
member_user_id: 用户ID
invite_code: 8位邀请码
status: 状态 (0-正常, 1-禁用)
use_count: 使用次数
max_use_count: 最大使用次数 (0-无限制)
expire_time: 过期时间
```

#### member_invite_record (邀请记录表)
```sql
member_invite_record_id: 主键
inviter_id: 邀请者ID
invitee_id: 被邀请者ID
invite_code: 使用的邀请码
status: 状态 (0-待奖励, 1-已奖励, 2-已取消)
inviter_reward: 邀请者奖励金额
invitee_reward: 被邀请者奖励金额
register_time: 注册时间
reward_time: 奖励发放时间
```

## 安全性考虑

1. **邀请码唯一性**: 系统自动生成8位随机邀请码，确保唯一性
2. **防重复注册**: 每个用户只能被邀请一次
3. **奖励延迟发放**: 注册24小时后发放邀请者奖励，防止恶意注册
4. **输入验证**: 邀请码格式和有效性验证
5. **使用次数限制**: 可设置邀请码最大使用次数

## 监控和维护

### 定期检查项目

1. **定时任务执行情况**
   - 检查任务调度日志
   - 确认奖励发放是否正常

2. **邀请数据统计**
   - 邀请成功率
   - 奖励发放金额统计
   - 异常邀请记录

3. **系统配置监控**
   - 奖励金额配置合理性
   - 定时任务执行时间

### 常见问题处理

1. **邀请码无效**: 检查邀请码格式和状态
2. **奖励未发放**: 检查定时任务执行情况
3. **重复邀请**: 系统自动防止同一用户被多次邀请

## 测试建议

1. **功能测试**
   - 邀请码生成和复制
   - 新用户注册使用邀请码
   - 奖励发放验证

2. **异常测试**
   - 无效邀请码注册
   - 重复使用邀请码
   - 定时任务失败处理

3. **性能测试**
   - 大量用户同时注册
   - 邀请记录查询性能

---

## 注意事项

1. 部署前请备份数据库
2. 建议在测试环境先验证功能
3. 监控定时任务执行情况
4. 定期检查邀请数据异常
5. 根据业务需求调整奖励金额