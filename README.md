# æ·³æ¸” CMS V2

## é¡¹ç›®ç®€ä»‹

æ·³æ¸”æ˜¯ä¸€æ¬¾å¿«é€Ÿæ­å»ºå½±è§†ç±»ç½‘ç«™çš„ç³»ç»Ÿï¼Œå®ƒç”¨æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½åŸºäº[nuxt3](https://nuxt.com/)å¼€å‘ ,ç®¡ç†ç«¯åŸºäº [vue3](https://cn.vuejs.org/) å’Œ [element-ui](https://element.eleme.cn/#/zh-CN) ï¼Œæ•°æ®åº“é‡‡ç”¨ mysql ï¼Œç¼“å­˜é‡‡ç”¨ redisã€‚

V2 ç›¸æ¯”[V1 ç‰ˆæœ¬](https://github.com/yinMrsir/chunyu-cms)ä½¿ç”¨[DrizzleOrm](https://orm.drizzle.team/)æ›¿æ¢äº† typeOrmï¼Œæˆ‘æƒ³ä½ ä¼šæ›´å®¹æ˜“ä¸Šæ‰‹æ“ä½œã€‚ä½†è¯·æ³¨æ„ä¸æ”¯æŒ mysql5.xï¼Œå»ºè®®ä½¿ç”¨ mysql8.xã€‚

## æ ¸å¿ƒåŠŸèƒ½

- ç”¨æˆ·ç«¯ç•Œé¢ï¼šé‡‡ç”¨ Nuxt3 æ„å»ºï¼Œæä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚
- ç®¡ç†ç«¯ç•Œé¢ï¼šåŸºäº Vue3 å’Œ Element-UIï¼Œæ–¹ä¾¿ç®¡ç†å‘˜è¿›è¡Œç½‘ç«™å†…å®¹çš„ç®¡ç†å’Œæ›´æ–°ã€‚
- è§†é¢‘èµ„æºç®¡ç†ï¼šæ·»åŠ ç¬¬ä¸‰æ–¹èµ„æºï¼Œå¦‚é­”éƒ½èµ„æºç­‰ã€‚
- å½±è§†è¯„åˆ†ç³»ç»Ÿï¼šç”¨æˆ·å¯ä»¥å¯¹å½±è§†ä½œå“è¿›è¡Œè¯„åˆ†å’Œè¯„è®ºã€‚
- å½±è§†æ¦œå•ï¼šæ ¹æ®å½±ç‰‡çƒ­åº¦æ’åï¼Œå®æ—¶å±•ç¤ºå‘¨æ¦œã€æœˆæ¦œã€å¹´æ¦œã€‚
- è§†é¢‘ä»˜è´¹è§‚çœ‹ï¼šæ”¯æŒè§†é¢‘å†…å®¹çš„ä»˜è´¹è§‚çœ‹ï¼Œä¸ºç½‘ç«™æä¾›ç›ˆåˆ©æ¸ é“ã€‚
- çŸ­è§†é¢‘ï¼šæ”¯æŒçŸ­è§†é¢‘çš„æ’­æ”¾ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼ çŸ­è§†é¢‘ã€‚

## åœ¨çº¿ä½“éªŒ

- [ç”¨æˆ·ç«¯æ¼”ç¤ºåœ°å€](http://cms.yinchunyu.com)
- [ç®¡ç†ç«¯æ¼”ç¤ºåœ°å€](http://cms.yinchunyu.com/admin)
- æºç åœ°å€: [GitHub](https://github.com/yinMrsir/chunyu-cms-v2)

## ä¸ºä»€ä¹ˆæœ‰ V2 ç‰ˆæœ¬ï¼Ÿ

è€ƒè™‘åˆ°å¤§éƒ¨åˆ†ä½¿ç”¨è€…ä¸ºä¸ªäººç‹¬ç«‹å¼€å‘ï¼ŒNuxt3 ä¹Ÿå¯ä»¥å¼€å‘æœåŠ¡ç«¯çš„åŠŸèƒ½ï¼Œæ‰€æœ‰æŠŠä¹‹å‰çš„ NestJS æœåŠ¡ç«¯ç§»é™¤äº†ï¼Œæ”¹ç”¨åˆ° Nuxt å®ç°ã€‚è¿™æ ·å°±å¯ä»¥ä¸ç”¨å¯åŠ¨ä¸¤ä¸ª Node æœåŠ¡äº†ã€‚

ä¹Ÿè€ƒè™‘äº†æ˜¯å¦åç»­ä¼šå°†åå°ç®¡ç†ç³»ç»Ÿä¹Ÿåˆå¹¶ï¼Œä½†ç›®å‰æ²¡æœ‰è®¡åˆ’ï¼Œã€

- ç¬¬ä¸€ï¼Œç®¡ç†ç«¯ä¸éœ€è¦ SEOã€‚
- ç¬¬äºŒï¼Œå¦‚ä½•éœ€è¦é›†æˆåˆ°ä¸€ä¸ªæœåŠ¡ä¸­ï¼Œå®Œå…¨å¯ä»¥æŠŠåå°ç®¡ç†ç³»ç»Ÿæ‰“åŒ…æ–‡ä»¶ç§»å…¥ Nuxt ç›®å½•ä¸­ï¼Œè¿™æ ·åªéœ€è¦ä¸€ä¸ªæœåŠ¡å³å¯ã€‚å¦‚ä¸‹é¢çš„[éƒ¨ç½²æ–¹å¼ä¸€](#æ–¹å¼ä¸€-å‘½ä»¤éƒ¨ç½²)
- ç¬¬ä¸‰ï¼Œç®¡ç†ç«¯ç§»å…¥ nuxt ä¸­ï¼Œä¼šè¦æ¶ˆè€—å¤§é‡æ—¶é—´ï¼Œå…ˆæŠŠæ—¶é—´ç”¨äºå…¶ä»–åœ°æ–¹ï¼ŒğŸ˜‚ã€‚

å½“ç„¶ï¼ŒNestJs æœ‰å®ƒçš„ä¼˜åŠ¿ï¼Œä¹Ÿæœ‰å¾ˆå¤šåŸºäºå®ƒçš„æ¨¡å—ï¼Œåœ¨æœ‰äº›åŠŸèƒ½ä¸Šå®ç°ä¼šæ›´æ–¹ä¾¿ï¼Œå¦‚ä½•ä½ å–œæ¬¢ NestJsï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨[ä¹‹å‰çš„ç‰ˆæœ¬](https://github.com/yinMrsir/chunyu-cms)ã€‚

## ä½¿ç”¨å‰

å¦‚æœªå®‰è£…`node`ï¼Œ`mysql`æ•°æ®åº“å’Œ`redis`è¯·å…ˆè‡ªè¡Œå®‰è£…ã€‚mysql8.xï¼Œredis7ã€‚æˆ–[ç‚¹å‡»æ­¤å¤„æœåŠ¡å™¨ç¯å¢ƒå®‰è£…æµç¨‹](æœåŠ¡å™¨ç¯å¢ƒå®‰è£…æµç¨‹.md)

**mysql**å’Œ**redis**é…ç½®ä½ å¯ä»¥åˆ°`chunyu-cms-web/nuxt.config.ts`è¿›è¡Œé…ç½®ã€‚ä½ ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ª`chunyu-cms-web/.env`æ–‡ä»¶

```dotenv
DATABASE_USERNAME=
DATABASE_PASSWORD=
DATABASE_HOST=127.0.0.1
DATABASE_PORT=3306
DATABASE_DB=chunyu-cms-v2

JWT_SECRET=chunyu-cms-v2
# redisé…ç½®
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_USERNAME=
REDIS_PASSWORD=
REDIS_DB=0
# æ˜¯å¦æ¼”ç¤ºç¯å¢ƒ
IS_DEMO_ENVIRONMENT=false
# æœåŠ¡ç«¯åŸŸå
SERVER_HOST=http://localhost:3000
# å›¾ç‰‡åŸŸå
IMG_HOST=http://localhost:3000
# ç”¨æˆ·å‘é€é‚®ä»¶çš„é‚®ç®±
FORM_USER_EMAIL=
# ç”¨æˆ·å‘é€é‚®ä»¶çš„é‚®ç®±å¯†ç  æ³¨æ„æ­¤å¤„ä¸ºqqé‚®ç®±çš„æˆæƒç ï¼Œä¸æ˜¯qqé‚®ç®±çš„å¯†ç 
FORM_USER_EMAIL_PASSWORD=
# ä½¿ç”¨ Gmail æœåŠ¡ï¼Œä½ å¯ä»¥ä½¿ç”¨å…¶ä»–æœåŠ¡ï¼Œå¦‚ 'QQ'
USER_EMAIL_SERVICE=QQ

# å¾®ä¿¡æ”¯ä»˜ï¼šç›´è¿å•†æˆ·ç”³è¯·çš„å…¬ä¼—å·æˆ–ç§»åŠ¨åº”ç”¨appid
WECHAT_PAY_APP_ID=
# å¾®ä¿¡æ”¯ä»˜ï¼šå•†æˆ·å·
WECHAT_PAY_MCH_ID=
# å…¬é’¥æ–‡ä»¶ç»å¯¹è·¯å¾„
WECHAT_PAY_PUBLIC_KEY=
# ç§˜é’¥æ–‡ä»¶ç»å¯¹è·¯å¾„
WECHAT_PAY_PRIVATE_KEY=
```

**æ³¨æ„ï¼š** `mysql`å’Œ`redis`çš„ç«¯å£å·ï¼Œç”¨æˆ·åï¼Œå¯†ç ï¼Œæ•°æ®åº“åç§°ï¼Œjwt åŠ å¯†å¯†é’¥ç­‰é…ç½®ä¿¡æ¯ï¼Œè¯·è‡ªè¡Œä¿®æ”¹ã€‚

## æ•°æ®åº“åˆå§‹åŒ–

1. å…ˆåˆ°æ•°æ®åº“ç›®å½•ä¸‹ï¼Œåˆ›å»ºæ•°æ®åº“`chunyu-cms-v2`
2. å¯¼å…¥æ•°æ®åº“æ–‡ä»¶`chunyu-cms-web/chunyu-cms-v2.sql`

## æœ¬åœ°å¼€å‘

### æœåŠ¡ç«¯å’Œç”¨æˆ·ç«¯åŒæ—¶å¯åŠ¨

```shell
cd chunyu-cms-web
pnpm install
pnpm dev
```

å¯åŠ¨æˆåŠŸåï¼Œè¯·è®¿é—®ï¼šhttp://localhost:3000

### ç®¡ç†ç«¯å¯åŠ¨

```shell
cd chunyu-cms-admin
pnpm install
pnpm dev
```

å¯åŠ¨æˆåŠŸåï¼Œè¯·è®¿é—®ï¼šhttp://localhost:4000, ç”¨æˆ·åï¼šadminï¼Œå¯†ç ï¼šadmin123

## éƒ¨ç½²

### æ–¹å¼ä¸€: å‘½ä»¤éƒ¨ç½²

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shell
node bin/deploy.js
```

éƒ¨ç½²å®Œæˆåå¯ä»¥è®¿é—®ï¼š

ç”¨æˆ·ç«¯ï¼šhttp://localhost:3000/

ç®¡ç†ç«¯ï¼šhttp://localhost:3000/admin/
ç”¨æˆ·åï¼šadminï¼Œå¯†ç ï¼šadmin123

æ­¤æ–¹å¼ä¼šæŠŠç®¡ç†ç«¯ä»£ç æ‹·è´åˆ°`chunyu-cms-web/admin`ç›®å½•ä¸­ï¼Œä½†æ­¤æ–¹å¼è·¯ç”±ä½¿ç”¨çš„æ˜¯ hash æ¨¡å¼ã€‚

âš ï¸ æ³¨æ„ï¼šä½ ä»éœ€è¦é€šè¿‡ nginx è®¾ç½®ä»£ç†åˆ°å­ç›®å½•, nginx å¦‚ä¸‹é…ç½®ï¼š

```nginx configuration
server {
    listen 80;
    server_name your.domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000/;
    }
    location /uploads {
        alias /path/to/chunyu-cms-v2/chunyu-cms-web/uploads;
    }
    location /admin {
        alias /path/to/chunyu-cms-v2/chunyu-cms-web/admin;
    }
}
```

### æ–¹å¼äºŒï¼šè‡ªè¡Œéƒ¨ç½²

#### æ„å»ºç®¡ç†ç«¯

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä¼šç”Ÿæˆ`dist`ç›®å½•ï¼Œå¯é€šè¿‡`nginx`æŒ‡å®šåˆ°ç›®å½•ã€‚

```shell
cd chunyu-cms-admin
pnpm isntall
pnpm build:prod
```

#### æ„å»ºæœåŠ¡ç«¯å’Œç”¨æˆ·ç«¯

```shell
cd chunyu-cms-web
pnpm isntall
pnpm build
```

æ„å»ºå®Œæˆåï¼Œå¯é€šè¿‡ pm2 è¿›è¡Œéƒ¨ç½²ï¼Œæœªå®‰è£…çš„å¯æ‰§è¡Œ`npm install -g pm2`å®‰è£…

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡ï¼š

```shell
pm2 start pm2.config.cjs
```

nginx é…ç½®å¦‚ä¸‹ï¼š

```nginx configuration
server {
    listen 80;
    server_name your.domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000/;
    }
    location /uploads {
        alias /path/to/chunyu-cms-v2/chunyu-cms-web/uploads;
    }
}

server {
    listen 80;
    server_name your.domain.com;

    location / {
        root  /path/to/chunyu-cms-v2/chunyu-cms-admin/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
```

nginx æ›´è¯¦ç»†é…ç½®å¯[æŸ¥çœ‹](nginx.conf)

Nuxt é¡¹ç›®éƒ¨ç½²æ–‡æ¡£ï¼šhttps://nuxt.com/docs/getting-started/deployment

## æ”¯ä»˜ç›¸å…³

å¾®ä¿¡æ”¯ä»˜åº“ï¼šhttps://github.com/klover2/wechatpay-node-v3-ts

å¾®ä¿¡æ”¯ä»˜å¼€å‘æ–‡æ¡£ï¼šhttps://pay.weixin.qq.com/doc/v3/merchant/4012791874

## drizzle ORM åŒæ­¥æ•°æ®åº“ç»“æ„

åˆ›å»º drizzle.config.ts æ–‡ä»¶

```json
{
  "dialect": "mysql",
  "out": "./server/db/migrations",
  "schema": "./server/db/schema/*/**",
  "dbCredentials": {
    "url": "mysql://ç”¨æˆ·å:å¯†ç @ipåœ°å€:3306/chunyu-cms-v2"
  }
}
```

ç”Ÿæˆæ•°æ®åº“ç»“æ„

```
pnpm generate
```

åŒæ­¥æ•°æ®åº“ç»“æ„

```
pnpm sql-push
```

## æœ‰ä»»ä½•ç–‘é—®å¯æ·»åŠ å¾®ä¿¡

<img src="https://raw.githubusercontent.com/yinMrsir/chunyu-cms-v2/refs/heads/main/wx.png" width="300" height="409" />
